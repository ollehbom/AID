name: Architect Agent

on:
  workflow_dispatch:
    inputs:
      feature_id:
        description: "Feature ID to process"
        required: true

jobs:
  run-agent:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
        with:
          ref: feature/${{ inputs.feature_id }}

      - name: Create working branch
        run: |
          git checkout -b ${{ inputs.feature_id }}-architect-stage
          git push -u origin ${{ inputs.feature_id }}-architect-stage

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          pip install -r requirements.txt

      - name: Run Architect Agent
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
          AI_PROVIDER: ${{ vars.AI_PROVIDER || 'openai' }}
          MODEL: ${{ vars.MODEL || 'gpt-4.1' }}
        run: |
          echo "üèóÔ∏è Invoking Architect Agent..."
          python scripts/invoke_architect_agent.py ${{ inputs.feature_id }}

      - name: Update pipeline state
        run: |
          sed -i 's/status:.*/status: architect_awaiting_approval/' .ai/pipeline/${{ inputs.feature_id }}.state
          sed -i 's/architect: pending/architect: in-progress/' .ai/pipeline/${{ inputs.feature_id }}.state

      - name: Commit outputs
        run: |
          git config user.name "Pipeline Bot"
          git config user.email "pipeline@aid.local"
          git add design/architecture/ design/technical-specs/ .ai/pipeline/
          git commit -m "Architect: ${{ inputs.feature_id }} review complete" || echo "No changes to commit"
          git push

      - name: Create Pull Request
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh pr create \
            --base feature/${{ inputs.feature_id }} \
            --head ${{ inputs.feature_id }}-architect-stage \
            --title "üèóÔ∏è Architect Agent: ${{ inputs.feature_id }}" \
            --body "## Architect Agent Output

          This PR contains the Architect Agent's technical review for \`${{ inputs.feature_id }}\`.

          ### üìã Outputs
          - Architecture Decision Records (ADRs)
          - Technical specifications
          - Implementation guidance

          ### ‚úÖ Review Checklist
          - [ ] Architecture is sound and scalable
          - [ ] Technical approach is appropriate
          - [ ] Dependencies are identified
          - [ ] Security considerations addressed

          **Next Stage:** After approval, the Dev Agent will be triggered.

          _Merge this PR to approve and proceed to the next stage._" \
            --label "stage:architect,awaiting-approval"
