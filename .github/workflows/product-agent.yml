name: Product Agent

on:
  workflow_dispatch:
    inputs:
      feature_id:
        description: "Feature ID to process"
        required: true

jobs:
  setup-branch:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      feature_branch: ${{ steps.branch-info.outputs.feature_branch }}
    steps:
      - uses: actions/checkout@v4

      - name: Check if feature branch exists
        id: check-branch
        run: |
          if git ls-remote --heads origin feature/${{ inputs.feature_id }} | grep -q feature/${{ inputs.feature_id }}; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Create feature branch if needed
        if: steps.check-branch.outputs.exists == 'false'
        run: |
          git checkout -b feature/${{ inputs.feature_id }}
          git push -u origin feature/${{ inputs.feature_id }}

      - name: Output branch info
        id: branch-info
        run: |
          echo "feature_branch=feature/${{ inputs.feature_id }}" >> $GITHUB_OUTPUT

  run-agent:
    needs: setup-branch
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
        with:
          ref: feature/${{ inputs.feature_id }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          pip install -r requirements.txt

      - name: Run Product Agent
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
          AI_PROVIDER: ${{ vars.AI_PROVIDER || 'openai' }}
          MODEL: ${{ vars.MODEL || 'gpt-4.1' }}
        run: |
          echo "ğŸ¤– Invoking Product Agent..."
          python scripts/invoke_product_agent.py ${{ inputs.feature_id }}

      - name: Read needs_design flag
        id: read-needs-design
        run: |
          NEEDS_DESIGN=$(grep "needs_design:" .ai/pipeline/${{ inputs.feature_id }}.state | cut -d: -f2 | xargs || echo "false")
          echo "needs_design=$NEEDS_DESIGN" >> $GITHUB_OUTPUT
          echo "Needs design: $NEEDS_DESIGN"

      - name: Update pipeline state
        run: |
          sed -i "s/status: .*/status: product_complete/" .ai/pipeline/${{ inputs.feature_id }}.state
          sed -i "s/product: .*/product: âœ“/" .ai/pipeline/${{ inputs.feature_id }}.state

      - name: Commit outputs
        run: |
          git config user.name "Pipeline Bot"
          git config user.email "pipeline@aid.local"
          git add product/decisions/ experiments/active.md .ai/pipeline/
          git commit -m "Product: ${{ inputs.feature_id }} analysis complete" || echo "No changes to commit"
          git push

      - name: Trigger next stage
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          NEEDS_DESIGN=$(grep "needs_design:" .ai/pipeline/${{ inputs.feature_id }}.state | cut -d: -f2 | xargs || echo "false")
          if [ "$NEEDS_DESIGN" = "true" ]; then
            echo "ğŸ¨ Triggering Design Agent..."
            gh workflow run design-agent.yml -f feature_id=${{ inputs.feature_id }}
          else
            echo "ğŸ—ï¸ Triggering Architect Agent..."
            gh workflow run architect-agent.yml -f feature_id=${{ inputs.feature_id }}
          fi
