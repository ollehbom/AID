name: QA Agent

on:
  workflow_dispatch:
    inputs:
      feature_id:
        description: "Feature ID to process"
        required: true

jobs:
  run-agent:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      actions: write
    steps:
      - uses: actions/checkout@v4
        with:
          ref: feature/${{ inputs.feature_id }}

      - name: Run QA Agent
        run: |
          echo "ðŸ§ª QA Agent validating implementation..."
          echo "TODO: Invoke QA Agent"
          echo "Reads: design/intents/${{ inputs.feature_id }}.md"
          echo "Writes: design/validations/${{ inputs.feature_id }}.md"

      - name: Update pipeline state
        run: |
          sed -i 's/status:.*/status: qa_complete/' .ai/pipeline/${{ inputs.feature_id }}.state
          sed -i 's/qa: .*/qa: âœ“/' .ai/pipeline/${{ inputs.feature_id }}.state

      - name: Commit outputs
        run: |
          git config user.name "Pipeline Bot"
          git config user.email "pipeline@aid.local"
          git add design/validations/ .ai/pipeline/
          git commit -m "QA: ${{ inputs.feature_id }} validation complete" || echo "No changes to commit"
          git push

      - name: Trigger next stage
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "ðŸš€ Triggering Ops Agent..."
          gh workflow run ops-agent.yml -f feature_id=${{ inputs.feature_id }}

      - name: Handle failure
        if: failure()
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          ERROR_ID="error-$(date +%Y%m%d-%H%M%S)"
          echo "ðŸ”´ Workflow failed - triggering auto-fix: $ERROR_ID"
          gh workflow run error-fix.yml -f error_id="$ERROR_ID" -f workflow_name="QA Agent"
