name: Pipeline Orchestrator

on:
  workflow_dispatch:
    inputs:
      stage:
        description: "Which stage to execute (auto-detect if empty)"
        required: false
        default: ""
      feature_id:
        description: "Feature ID to process"
        required: true

jobs:
  detect-stage:
    runs-on: ubuntu-latest
    outputs:
      current_stage: ${{ steps.read-state.outputs.stage }}
    steps:
      - uses: actions/checkout@v4

      - name: Read pipeline state
        id: read-state
        run: |
          if [ -f ".ai/pipeline/${{ inputs.feature_id }}.state" ]; then
            STAGE=$(grep "status:" .ai/pipeline/${{ inputs.feature_id }}.state | cut -d: -f2 | xargs)
            echo "stage=$STAGE" >> $GITHUB_OUTPUT
          else
            echo "stage=intake" >> $GITHUB_OUTPUT
          fi

  product-agent:
    needs: detect-stage
    if: needs.detect-stage.outputs.current_stage == 'intake'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run Product Agent
        run: |
          echo "Product Agent analyzing feedback..."
          # TODO: Invoke Product Agent (Copilot CLI or script)
          # Reads: product/feedback/inbox.md
          # Writes: product/decisions/${{ inputs.feature_id }}.md
          #         experiments/active.md

      - name: Update state
        run: |
          mkdir -p .ai/pipeline
          cat > .ai/pipeline/${{ inputs.feature_id }}.state << EOF
          feature: ${{ inputs.feature_id }}
          status: product_complete
          stages:
            product: ✓ $(date +%Y-%m-%d)
            design: pending
            dev: pending
            qa: pending
            ops: pending
          EOF

      - name: Commit outputs
        run: |
          git config user.name "Pipeline Bot"
          git config user.email "pipeline@aid.local"
          git add product/decisions/ experiments/active.md .ai/pipeline/
          git commit -m "Product: ${{ inputs.feature_id }} analysis complete"
          git push

  design-agent:
    needs: detect-stage
    if: needs.detect-stage.outputs.current_stage == 'product_complete'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run Design Agent
        run: |
          echo "Design Agent creating intent and spec..."
          # TODO: Invoke Design Agent
          # Reads: experiments/active.md, product/beliefs/current.md
          # Writes: design/intents/${{ inputs.feature_id }}.md
          #         design/specs/${{ inputs.feature_id }}.md

      - name: Update state
        run: |
          sed -i 's/status:.*/status: design_complete/' .ai/pipeline/${{ inputs.feature_id }}.state
          sed -i 's/design: pending/design: ✓ '"$(date +%Y-%m-%d)"'/' .ai/pipeline/${{ inputs.feature_id }}.state

      - name: Commit outputs
        run: |
          git config user.name "Pipeline Bot"
          git config user.email "pipeline@aid.local"
          git add design/ .ai/pipeline/
          git commit -m "Design: ${{ inputs.feature_id }} spec complete"
          git push

  dev-agent:
    needs: detect-stage
    if: needs.detect-stage.outputs.current_stage == 'design_complete'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run Dev Agent
        run: |
          echo "Dev Agent implementing feature..."
          # TODO: Invoke Dev Agent
          # Reads: design/specs/${{ inputs.feature_id }}.md
          # Writes: Code changes, creates PR

      - name: Create implementation PR
        run: |
          # This would create a PR with the implementation
          echo "Implementation PR created"

      - name: Update state (after PR merge)
        run: |
          sed -i 's/status:.*/status: dev_complete/' .ai/pipeline/${{ inputs.feature_id }}.state
          sed -i 's/dev: pending/dev: ✓ '"$(date +%Y-%m-%d)"'/' .ai/pipeline/${{ inputs.feature_id }}.state

  qa-agent:
    needs: detect-stage
    if: needs.detect-stage.outputs.current_stage == 'dev_complete'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run QA Agent
        run: |
          echo "QA Agent validating implementation..."
          # TODO: Invoke QA Agent
          # Reads: design/intents/${{ inputs.feature_id }}.md
          # Writes: design/validations/${{ inputs.feature_id }}.md

      - name: Check validation results
        id: qa-check
        run: |
          # Check if validation passed
          if grep -q "PASS" design/validations/${{ inputs.feature_id }}.md; then
            echo "result=pass" >> $GITHUB_OUTPUT
          else
            echo "result=fail" >> $GITHUB_OUTPUT
          fi

      - name: Update state (pass)
        if: steps.qa-check.outputs.result == 'pass'
        run: |
          sed -i 's/status:.*/status: qa_complete/' .ai/pipeline/${{ inputs.feature_id }}.state
          sed -i 's/qa: pending/qa: ✓ '"$(date +%Y-%m-%d)"'/' .ai/pipeline/${{ inputs.feature_id }}.state

      - name: Update state (fail - rollback to dev)
        if: steps.qa-check.outputs.result == 'fail'
        run: |
          sed -i 's/status:.*/status: dev_complete/' .ai/pipeline/${{ inputs.feature_id }}.state
          echo "QA validation failed. Returning to Dev stage."

      - name: Commit results
        run: |
          git config user.name "Pipeline Bot"
          git config user.email "pipeline@aid.local"
          git add design/validations/ .ai/pipeline/
          git commit -m "QA: ${{ inputs.feature_id }} validation results"
          git push

  ops-agent:
    needs: detect-stage
    if: needs.detect-stage.outputs.current_stage == 'qa_complete'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run Ops Agent
        run: |
          echo "Ops Agent deploying feature..."
          # TODO: Invoke Ops Agent
          # Reads: design/validations/${{ inputs.feature_id }}.md
          # Writes: Deployment logs, monitoring config

      - name: Deploy with feature flag
        run: |
          echo "Deploying behind feature flag: ${{ inputs.feature_id }}"
          # Gradual rollout logic here

      - name: Update state
        run: |
          sed -i 's/status:.*/status: deployed/' .ai/pipeline/${{ inputs.feature_id }}.state
          sed -i 's/ops: pending/ops: ✓ '"$(date +%Y-%m-%d)"'/' .ai/pipeline/${{ inputs.feature_id }}.state

      - name: Archive experiment
        run: |
          # Move from active to archive
          echo "Feature deployed: ${{ inputs.feature_id }}"

      - name: Commit completion
        run: |
          git config user.name "Pipeline Bot"
          git config user.email "pipeline@aid.local"
          git add .ai/pipeline/ experiments/
          git commit -m "Ops: ${{ inputs.feature_id }} deployed"
          git push
