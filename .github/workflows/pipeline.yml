name: Pipeline Orchestrator

on:
  workflow_dispatch:
    inputs:
      stage:
        description: "Which stage to execute"
        required: true
        type: choice
        options:
          - product
          - design
          - architect
          - dev
          - qa
          - ops
      feature_id:
        description: "Feature ID to process"
        required: true

jobs:
  setup-branch:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      feature_branch: ${{ steps.branch-info.outputs.feature_branch }}
      branch_exists: ${{ steps.check-branch.outputs.exists }}
    steps:
      - uses: actions/checkout@v4

      - name: Check if feature branch exists
        id: check-branch
        run: |
          if git ls-remote --heads origin feature/${{ inputs.feature_id }} | grep -q feature/${{ inputs.feature_id }}; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Create feature branch if needed
        if: steps.check-branch.outputs.exists == 'false'
        run: |
          git checkout -b feature/${{ inputs.feature_id }}
          git push -u origin feature/${{ inputs.feature_id }}

      - name: Output branch info
        id: branch-info
        run: |
          echo "feature_branch=feature/${{ inputs.feature_id }}" >> $GITHUB_OUTPUT

  product-agent:
    needs: setup-branch
    if: inputs.stage == 'product'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
        with:
          ref: feature/${{ inputs.feature_id }}

      - name: Create working branch
        run: |
          git checkout -b ${{ inputs.feature_id }}-product-stage
          git push -u origin ${{ inputs.feature_id }}-product-stage

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          pip install -r requirements.txt

      - name: Run Product Agent
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
          AI_PROVIDER: ${{ vars.AI_PROVIDER || 'openai' }}
          MODEL: ${{ vars.MODEL || 'gpt-4.1' }}
        run: |
          echo "ğŸ¤– Invoking Product Agent..."
          python scripts/invoke_product_agent.py ${{ inputs.feature_id }}

      - name: Read needs_design flag
        id: read-needs-design
        run: |
          NEEDS_DESIGN=$(grep "needs_design:" .ai/pipeline/${{ inputs.feature_id }}.state | cut -d: -f2 | xargs || echo "false")
          echo "needs_design=$NEEDS_DESIGN" >> $GITHUB_OUTPUT
          echo "Needs design: $NEEDS_DESIGN"

      - name: Update pipeline state to awaiting approval
        run: |
          # Preserve needs_design from product agent output
          NEEDS_DESIGN="${{ steps.read-needs-design.outputs.needs_design }}"

          sed -i "s/status: product_complete/status: product_awaiting_approval/" .ai/pipeline/${{ inputs.feature_id }}.state
          sed -i "s/product: âœ“/product: in-progress/" .ai/pipeline/${{ inputs.feature_id }}.state

      - name: Commit outputs
        run: |
          git config user.name "Pipeline Bot"
          git config user.email "pipeline@aid.local"
          git add product/decisions/ experiments/active.md .ai/pipeline/
          git commit -m "Product: ${{ inputs.feature_id }} analysis complete" || echo "No changes to commit"
          git push

      - name: Create Pull Request
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh pr create \
            --base feature/${{ inputs.feature_id }} \
            --head ${{ inputs.feature_id }}-product-stage \
            --title "ğŸ¤– Product Agent: ${{ inputs.feature_id }}" \
            --body "## Product Agent Output

          This PR contains the Product Agent's analysis for \`${{ inputs.feature_id }}\`.

          ### ğŸ“‹ Outputs
          - Product decision record
          - Experiment tracking entry
          - Pipeline state initialized

          ### âœ… Review Checklist
          - [ ] Decision record is clear and actionable
          - [ ] Experiment hypothesis is testable
          - [ ] Success criteria are measurable
          - [ ] Affected beliefs are identified

          **Next Stage:** After approval, the $(grep 'needs_design:' .ai/pipeline/${{ inputs.feature_id }}.state | grep -q 'true' && echo 'Design' || echo 'Architect') Agent will be triggered.

          _Merge this PR to approve and proceed to the next stage._" \
            --label "stage:product,awaiting-approval"

  design-agent:
    needs: setup-branch
    if: inputs.stage == 'design'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
        with:
          ref: feature/${{ inputs.feature_id }}

      - name: Create working branch
        run: |
          git checkout -b ${{ inputs.feature_id }}-design-stage
          git push -u origin ${{ inputs.feature_id }}-design-stage

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          pip install -r requirements.txt

      - name: Run Design Agent
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
          AI_PROVIDER: ${{ vars.AI_PROVIDER || 'openai' }}
          MODEL: ${{ vars.MODEL || 'gpt-4.1' }}
        run: |
          echo "ğŸ¨ Invoking Design Agent..."
          python scripts/invoke_design_agent.py ${{ inputs.feature_id }}

      - name: Update pipeline state
        run: |
          sed -i 's/status:.*/status: design_awaiting_approval/' .ai/pipeline/${{ inputs.feature_id }}.state
          sed -i 's/design: pending/design: in-progress/' .ai/pipeline/${{ inputs.feature_id }}.state

      - name: Commit outputs
        run: |
          git config user.name "Pipeline Bot"
          git config user.email "pipeline@aid.local"
          git add design/ .ai/pipeline/
          git commit -m "Design: ${{ inputs.feature_id }} spec complete" || echo "No changes to commit"
          git push

      - name: Create Pull Request
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh pr create \
            --base feature/${{ inputs.feature_id }} \
            --head ${{ inputs.feature_id }}-design-stage \
            --title "ğŸ¨ Design Agent: ${{ inputs.feature_id }}" \
            --body "## Design Agent Output

          This PR contains the Design Agent's specifications for \`${{ inputs.feature_id }}\`.

          ### ğŸ“‹ Outputs
          - Design specifications
          - User flows and wireframes
          - UI/UX requirements

          ### âœ… Review Checklist
          - [ ] Design meets user needs
          - [ ] Flows are clear and intuitive
          - [ ] Edge cases are addressed
          - [ ] Accessibility considerations included

          **Next Stage:** After approval, the Architect Agent will be triggered.

          _Merge this PR to approve and proceed to the next stage._" \
            --label "stage:design,awaiting-approval"

  architect-agent:
    needs: setup-branch
    if: inputs.stage == 'architect'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
        with:
          ref: feature/${{ inputs.feature_id }}

      - name: Create working branch
        run: |
          git checkout -b ${{ inputs.feature_id }}-architect-stage
          git push -u origin ${{ inputs.feature_id }}-architect-stage

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          pip install -r requirements.txt

      - name: Run Architect Agent
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
          AI_PROVIDER: ${{ vars.AI_PROVIDER || 'openai' }}
          MODEL: ${{ vars.MODEL || 'gpt-4.1' }}
        run: |
          echo "ğŸ—ï¸ Invoking Architect Agent..."
          python scripts/invoke_architect_agent.py ${{ inputs.feature_id }}

      - name: Update pipeline state
        run: |
          sed -i 's/status:.*/status: architect_awaiting_approval/' .ai/pipeline/${{ inputs.feature_id }}.state
          sed -i 's/architect: pending/architect: in-progress/' .ai/pipeline/${{ inputs.feature_id }}.state

      - name: Commit outputs
        run: |
          git config user.name "Pipeline Bot"
          git config user.email "pipeline@aid.local"
          git add design/architecture/ design/technical-specs/ .ai/pipeline/
          git commit -m "Architect: ${{ inputs.feature_id }} review complete" || echo "No changes to commit"
          git push

      - name: Create Pull Request
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh pr create \
            --base feature/${{ inputs.feature_id }} \
            --head ${{ inputs.feature_id }}-architect-stage \
            --title "ğŸ—ï¸ Architect Agent: ${{ inputs.feature_id }}" \
            --body "## Architect Agent Output

          This PR contains the Architect Agent's technical review for \`${{ inputs.feature_id }}\`.

          ### ğŸ“‹ Outputs
          - Architecture Decision Records (ADRs)
          - Technical specifications
          - Implementation guidance

          ### âœ… Review Checklist
          - [ ] Architecture is sound and scalable
          - [ ] Technical approach is appropriate
          - [ ] Dependencies are identified
          - [ ] Security considerations addressed

          **Next Stage:** After approval, the Dev Agent will be triggered.

          _Merge this PR to approve and proceed to the next stage._" \
            --label "stage:architect,awaiting-approval"

  dev-agent:
    needs: setup-branch
    if: inputs.stage == 'dev'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
        with:
          ref: feature/${{ inputs.feature_id }}

      - name: Create working branch
        run: |
          git checkout -b ${{ inputs.feature_id }}-dev-stage
          git push -u origin ${{ inputs.feature_id }}-dev-stage

      - name: Run Dev Agent
        run: |
          echo "ğŸ’» Dev Agent implementing feature..."
          echo "TODO: Invoke Dev Agent"
          echo "Reads: design/architecture/ADR-*-${{ inputs.feature_id }}.md"
          echo "       design/technical-specs/${{ inputs.feature_id }}.md"
          echo "       design/specs/${{ inputs.feature_id }}.md (if exists)"
          echo "Writes: Code changes"

      - name: Update pipeline state
        run: |
          sed -i 's/status:.*/status: dev_awaiting_approval/' .ai/pipeline/${{ inputs.feature_id }}.state
          sed -i 's/dev: pending/dev: in-progress/' .ai/pipeline/${{ inputs.feature_id }}.state

      - name: Commit outputs
        run: |
          git config user.name "Pipeline Bot"
          git config user.email "pipeline@aid.local"
          git add .ai/pipeline/
          git commit -m "Dev: ${{ inputs.feature_id }} implementation complete" || echo "No changes to commit"
          git push

      - name: Create Pull Request
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh pr create \
            --base feature/${{ inputs.feature_id }} \
            --head ${{ inputs.feature_id }}-dev-stage \
            --title "ğŸ’» Dev Agent: ${{ inputs.feature_id }}" \
            --body "## Dev Agent Output

          This PR contains the Dev Agent's implementation for \`${{ inputs.feature_id }}\`.

          ### ğŸ“‹ Outputs
          - Implementation code
          - Unit tests
          - Documentation updates

          ### âœ… Review Checklist
          - [ ] Code follows style guidelines
          - [ ] Tests are comprehensive
          - [ ] Documentation is updated
          - [ ] No obvious bugs or issues

          **Next Stage:** After approval, the QA Agent will be triggered.

          _Merge this PR to approve and proceed to the next stage._" \
            --label "stage:dev,awaiting-approval"

  qa-agent:
    needs: setup-branch
    if: inputs.stage == 'qa'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
        with:
          ref: feature/${{ inputs.feature_id }}

      - name: Create working branch
        run: |
          git checkout -b ${{ inputs.feature_id }}-qa-stage
          git push -u origin ${{ inputs.feature_id }}-qa-stage

      - name: Run QA Agent
        run: |
          echo "ğŸ§ª QA Agent validating implementation..."
          echo "TODO: Invoke QA Agent"
          echo "Reads: design/intents/${{ inputs.feature_id }}.md"
          echo "Writes: design/validations/${{ inputs.feature_id }}.md"

      - name: Update pipeline state
        run: |
          sed -i 's/status:.*/status: qa_awaiting_approval/' .ai/pipeline/${{ inputs.feature_id }}.state
          sed -i 's/qa: pending/qa: in-progress/' .ai/pipeline/${{ inputs.feature_id }}.state

      - name: Commit outputs
        run: |
          git config user.name "Pipeline Bot"
          git config user.email "pipeline@aid.local"
          git add design/validations/ .ai/pipeline/
          git commit -m "QA: ${{ inputs.feature_id }} validation complete" || echo "No changes to commit"
          git push

      - name: Create Pull Request
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh pr create \
            --base feature/${{ inputs.feature_id }} \
            --head ${{ inputs.feature_id }}-qa-stage \
            --title "ğŸ§ª QA Agent: ${{ inputs.feature_id }}" \
            --body "## QA Agent Output

          This PR contains the QA Agent's validation for \`${{ inputs.feature_id }}\`.

          ### ğŸ“‹ Outputs
          - Test results
          - Validation report
          - Issues found (if any)

          ### âœ… Review Checklist
          - [ ] All tests pass
          - [ ] No critical bugs
          - [ ] Performance is acceptable
          - [ ] Ready for deployment

          **Next Stage:** After approval, the Ops Agent will be triggered.

          _Merge this PR to approve and proceed to the next stage._" \
            --label "stage:qa,awaiting-approval"

  ops-agent:
    needs: setup-branch
    if: inputs.stage == 'ops'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
        with:
          ref: feature/${{ inputs.feature_id }}

      - name: Create working branch
        run: |
          git checkout -b ${{ inputs.feature_id }}-ops-stage
          git push -u origin ${{ inputs.feature_id }}-ops-stage

      - name: Run Ops Agent
        run: |
          echo "ğŸš€ Ops Agent deploying feature..."
          echo "TODO: Invoke Ops Agent"
          echo "Reads: design/validations/${{ inputs.feature_id }}.md"
          echo "Writes: Deployment logs, monitoring config"

      - name: Update pipeline state
        run: |
          sed -i 's/status:.*/status: ops_awaiting_approval/' .ai/pipeline/${{ inputs.feature_id }}.state
          sed -i 's/ops: pending/ops: in-progress/' .ai/pipeline/${{ inputs.feature_id }}.state

      - name: Commit outputs
        run: |
          git config user.name "Pipeline Bot"
          git config user.email "pipeline@aid.local"
          git add .ai/pipeline/
          git commit -m "Ops: ${{ inputs.feature_id }} deployment ready" || echo "No changes to commit"
          git push

      - name: Create Pull Request to Main
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # First push the ops changes to feature branch
          git push origin ${{ inputs.feature_id }}-ops-stage

          # Create PR from working branch to feature branch
          gh pr create \
            --base feature/${{ inputs.feature_id }} \
            --head ${{ inputs.feature_id }}-ops-stage \
            --title "ğŸš€ Ops Agent: ${{ inputs.feature_id }}" \
            --body "## Ops Agent Output

          This PR contains the Ops Agent's deployment preparation for \`${{ inputs.feature_id }}\`.

          ### ğŸ“‹ Outputs
          - Deployment configuration
          - Monitoring setup
          - Feature flag configuration

          ### âœ… Review Checklist
          - [ ] Deployment plan is sound
          - [ ] Monitoring is configured
          - [ ] Rollback plan is ready
          - [ ] Ready to merge to main

          **Final Stage:** After approval, merge this PR, then create a PR from feature branch to main for final deployment.

          _Merge this PR to approve._" \
            --label "stage:ops,awaiting-approval"
