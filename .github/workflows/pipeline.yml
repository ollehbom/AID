name: Pipeline

on:
  workflow_dispatch:
    inputs:
      feature_id:
        description: "Feature ID to process"
        required: true

jobs:
  setup:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Create feature branch if needed
        run: |
          if git ls-remote --heads origin feature/${{ inputs.feature_id }} | grep -q feature/${{ inputs.feature_id }}; then
            echo "Branch exists, checking out"
            git fetch origin feature/${{ inputs.feature_id }}
            git checkout feature/${{ inputs.feature_id }}
          else
            echo "Creating new branch"
            git checkout -b feature/${{ inputs.feature_id }}
            git push -u origin feature/${{ inputs.feature_id }}
          fi

  product:
    needs: setup
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          ref: feature/${{ inputs.feature_id }}

      - name: Check if stage already complete
        id: check_status
        run: |
          if [ -f ".ai/pipeline/${{ inputs.feature_id }}.state" ]; then
            if grep -q "product: âœ“" .ai/pipeline/${{ inputs.feature_id }}.state; then
              echo "Stage already complete, skipping"
              echo "skip=true" >> $GITHUB_OUTPUT
              exit 0
            fi
          fi
          echo "skip=false" >> $GITHUB_OUTPUT

      - name: Set up Python
        if: steps.check_status.outputs.skip != 'true'
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        if: steps.check_status.outputs.skip != 'true'
        run: pip install -r requirements.txt

      - name: Run Product Agent
        if: steps.check_status.outputs.skip != 'true'
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
          AI_PROVIDER: ${{ vars.AI_PROVIDER || 'openai' }}
          MODEL: ${{ vars.MODEL || 'gpt-4.1' }}
          SAVE_JSON_ARTIFACTS: "true"
        run: |
          echo "ðŸ¤– Running Product Agent..."
          python scripts/invoke_product_agent.py ${{ inputs.feature_id }}

      - name: Upload JSON artifacts
        if: always() && steps.check_status.outputs.skip != 'true'
        uses: actions/upload-artifact@v4
        with:
          name: product-json-artifacts-${{ inputs.feature_id }}
          path: json_artifacts/
          if-no-files-found: ignore

      - name: Update pipeline state
        if: steps.check_status.outputs.skip != 'true'
        run: |
          sed -i "s/status: .*/status: product_complete/" .ai/pipeline/${{ inputs.feature_id }}.state
          sed -i "s/product: .*/product: âœ“/" .ai/pipeline/${{ inputs.feature_id }}.state

      - name: Commit outputs
        if: steps.check_status.outputs.skip != 'true'
        run: |
          git config user.name "Pipeline Bot"
          git config user.email "pipeline@aid.local"
          git add product/decisions/ experiments/active.md .ai/pipeline/
          git commit -m "Product: ${{ inputs.feature_id }} analysis complete" || echo "No changes"
          git push

  design:
    needs: product
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          ref: feature/${{ inputs.feature_id }}

      - name: Check if stage already complete
        id: check_status
        run: |
          if [ -f ".ai/pipeline/${{ inputs.feature_id }}.state" ]; then
            if grep -q "design: âœ“" .ai/pipeline/${{ inputs.feature_id }}.state; then
              echo "Stage already complete, skipping"
              echo "skip=true" >> $GITHUB_OUTPUT
              exit 0
            fi
          fi
          echo "skip=false" >> $GITHUB_OUTPUT

      - name: Set up Python
        if: steps.check_status.outputs.skip != 'true'
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        if: steps.check_status.outputs.skip != 'true'
        run: pip install -r requirements.txt

      - name: Check if design needed
        if: steps.check_status.outputs.skip != 'true'
        id: check-design
        run: |
          NEEDS_DESIGN=$(grep "needs_design:" .ai/pipeline/${{ inputs.feature_id }}.state | cut -d: -f2 | xargs || echo "false")
          echo "needs_design=$NEEDS_DESIGN" >> $GITHUB_OUTPUT
          if [ "$NEEDS_DESIGN" = "false" ]; then
            echo "â­ï¸ Skipping Design Agent (not needed)"
          fi

      - name: Run Design Agent
        if: steps.check_status.outputs.skip != 'true' && steps.check-design.outputs.needs_design == 'true'
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
          AI_PROVIDER: ${{ vars.AI_PROVIDER || 'openai' }}
          MODEL: ${{ vars.MODEL || 'gpt-4.1' }}
          SAVE_JSON_ARTIFACTS: "true"
        run: |
          echo "ðŸŽ¨ Running Design Agent (Iterative Mode)..."
          python scripts/invoke_design_agent_iterative.py ${{ inputs.feature_id }}

      - name: Upload JSON artifacts
        if: always() && steps.check_status.outputs.skip != 'true'
        uses: actions/upload-artifact@v4
        with:
          name: design-json-artifacts-${{ inputs.feature_id }}
          path: json_artifacts/
          if-no-files-found: ignore

      - name: Update pipeline state
        if: steps.check_status.outputs.skip != 'true' && steps.check-design.outputs.needs_design == 'true'
        run: |
          sed -i 's/status:.*/status: design_complete/' .ai/pipeline/${{ inputs.feature_id }}.state
          sed -i 's/design: .*/design: âœ“/' .ai/pipeline/${{ inputs.feature_id }}.state

      - name: Commit outputs
        if: steps.check_status.outputs.skip != 'true' && steps.check-design.outputs.needs_design == 'true'
        run: |
          git config user.name "Pipeline Bot"
          git config user.email "pipeline@aid.local"
          git add design/ .ai/pipeline/
          git commit -m "Design: ${{ inputs.feature_id }} spec complete" || echo "No changes"
          git push

  architect:
    needs: design
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          ref: feature/${{ inputs.feature_id }}

      - name: Check if stage already complete
        id: check_status
        run: |
          if [ -f ".ai/pipeline/${{ inputs.feature_id }}.state" ]; then
            if grep -q "architect: âœ“" .ai/pipeline/${{ inputs.feature_id }}.state; then
              echo "Stage already complete, skipping"
              echo "skip=true" >> $GITHUB_OUTPUT
              exit 0
            fi
          fi
          echo "skip=false" >> $GITHUB_OUTPUT

      - name: Set up Python
        if: steps.check_status.outputs.skip != 'true'
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        if: steps.check_status.outputs.skip != 'true'
        run: pip install -r requirements.txt

      - name: Run Architect Agent
        if: steps.check_status.outputs.skip != 'true'
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
          AI_PROVIDER: ${{ vars.AI_PROVIDER || 'openai' }}
          MODEL: ${{ vars.MODEL || 'gpt-4.1' }}
          SAVE_JSON_ARTIFACTS: "true"
        run: |
          echo "ðŸ—ï¸ Running Architect Agent..."
          python scripts/invoke_architect_agent.py ${{ inputs.feature_id }}

      - name: Upload JSON artifacts
        if: always() && steps.check_status.outputs.skip != 'true'
        uses: actions/upload-artifact@v4
        with:
          name: architect-json-artifacts-${{ inputs.feature_id }}
          path: json_artifacts/
          if-no-files-found: ignore

      - name: Update pipeline state
        if: steps.check_status.outputs.skip != 'true'
        run: |
          sed -i 's/status:.*/status: architect_complete/' .ai/pipeline/${{ inputs.feature_id }}.state
          sed -i 's/architect: .*/architect: âœ“/' .ai/pipeline/${{ inputs.feature_id }}.state

      - name: Commit outputs
        if: steps.check_status.outputs.skip != 'true'
        run: |
          git config user.name "Pipeline Bot"
          git config user.email "pipeline@aid.local"
          git add design/architecture/ design/technical-specs/ .ai/pipeline/
          git commit -m "Architect: ${{ inputs.feature_id }} review complete" || echo "No changes"
          git push

  dev:
    needs: architect
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          ref: feature/${{ inputs.feature_id }}

      - name: Check if stage already complete
        id: check_status
        run: |
          ERROR_CONTEXT_FILE=".ai/pipeline/${{ inputs.feature_id }}.error-context.json"
          
          # Check if there's error context (error-fix ran)
          if [ -f "$ERROR_CONTEXT_FILE" ]; then
            echo "Error context found - dev agent will re-run to validate fixes"
            echo "skip=false" >> $GITHUB_OUTPUT
            echo "has_error_context=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Normal completion check
          if [ -f ".ai/pipeline/${{ inputs.feature_id }}.state" ]; then
            if grep -q "dev: âœ“" .ai/pipeline/${{ inputs.feature_id }}.state; then
              echo "Stage already complete, skipping"
              echo "skip=true" >> $GITHUB_OUTPUT
              echo "has_error_context=false" >> $GITHUB_OUTPUT
              exit 0
            fi
          fi
          
          echo "skip=false" >> $GITHUB_OUTPUT
          echo "has_error_context=false" >> $GITHUB_OUTPUT

      - name: Set up Python
        if: steps.check_status.outputs.skip != 'true'
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        if: steps.check_status.outputs.skip != 'true'
        run: pip install openai google-genai python-dotenv

      - name: Run Dev Agent
        if: steps.check_status.outputs.skip != 'true'
        env:
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          AI_PROVIDER: ${{ vars.AI_PROVIDER }}
          MODEL: ${{ vars.MODEL }}
          SAVE_JSON_ARTIFACTS: "true"
          ERROR_CONTEXT_FILE: ${{ steps.check_status.outputs.has_error_context == 'true' && format('.ai/pipeline/{0}.error-context.json', inputs.feature_id) || '' }}
        run: |
          if [ "${{ steps.check_status.outputs.has_error_context }}" = "true" ]; then
            echo "ðŸ’» Running Dev Agent with error context (validating fixes)..."
            echo "Error context: $ERROR_CONTEXT_FILE"
          else
            echo "ðŸ’» Running Dev Agent..."
          fi
          python scripts/invoke_dev_agent_iterative.py "${{ inputs.feature_id }}"

      - name: Upload JSON artifacts
        if: always() && steps.check_status.outputs.skip != 'true'
        uses: actions/upload-artifact@v4
        with:
          name: dev-json-artifacts-${{ inputs.feature_id }}
          path: json_artifacts/
          if-no-files-found: ignore

      - name: Build and validate generated code
        if: steps.check_status.outputs.skip != 'true'
        id: build_validation
        run: |
          echo "ðŸ”¨ Building and validating generated code..."

          BUILD_FILE=".ai/pipeline/${{ inputs.feature_id }}.build.json"

          if [ ! -f "$BUILD_FILE" ]; then
            echo "âš ï¸  No build commands found, skipping validation"
            echo "validation_passed=skipped" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Extract build commands
          WORKING_DIR=$(jq -r '.working_dir // "."' "$BUILD_FILE")
          INSTALL_CMD=$(jq -r '.install // ""' "$BUILD_FILE")
          BUILD_CMD=$(jq -r '.build // ""' "$BUILD_FILE")
          TEST_CMD=$(jq -r '.test // ""' "$BUILD_FILE")

          echo "Working directory: $WORKING_DIR"
          cd "$WORKING_DIR" || exit 1

          # Install dependencies
          if [ -n "$INSTALL_CMD" ] && [ "$INSTALL_CMD" != "null" ]; then
            echo "ðŸ“¦ Installing dependencies: $INSTALL_CMD"
            if ! eval "$INSTALL_CMD"; then
              echo "âŒ Dependency installation failed"
              echo "validation_passed=false" >> $GITHUB_OUTPUT
              exit 1
            fi
          fi

          # Build project
          if [ -n "$BUILD_CMD" ] && [ "$BUILD_CMD" != "null" ]; then
            echo "ðŸ”¨ Building: $BUILD_CMD"
            if ! eval "$BUILD_CMD"; then
              echo "âŒ Build failed"
              echo "validation_passed=false" >> $GITHUB_OUTPUT
              exit 1
            fi
          fi

          # Run tests
          if [ -n "$TEST_CMD" ] && [ "$TEST_CMD" != "null" ]; then
            echo "ðŸ§ª Running tests: $TEST_CMD"
            if ! eval "$TEST_CMD"; then
              echo "âŒ Tests failed"
              echo "validation_passed=false" >> $GITHUB_OUTPUT
              exit 1
            fi
          fi

          echo "âœ… Build and tests passed!"
          echo "validation_passed=true" >> $GITHUB_OUTPUT

      - name: Update pipeline state
        if: steps.check_status.outputs.skip != 'true'
        run: |
          sed -i 's/status:.*/status: dev_complete/' .ai/pipeline/${{ inputs.feature_id }}.state
          sed -i 's/dev: .*/dev: âœ“/' .ai/pipeline/${{ inputs.feature_id }}.state

          # Add validation result
          if [ "${{ steps.build_validation.outputs.validation_passed }}" = "true" ]; then
            echo "  build_validation: âœ“" >> .ai/pipeline/${{ inputs.feature_id }}.state
          elif [ "${{ steps.build_validation.outputs.validation_passed }}" = "false" ]; then
            echo "  build_validation: âœ— failed" >> .ai/pipeline/${{ inputs.feature_id }}.state
          else
            echo "  build_validation: - skipped" >> .ai/pipeline/${{ inputs.feature_id }}.state
          fi
          
          # Clean up error context after successful validation
          if [ "${{ steps.check_status.outputs.has_error_context }}" = "true" ]; then
            if [ "${{ steps.build_validation.outputs.validation_passed }}" = "true" ]; then
              rm -f ".ai/pipeline/${{ inputs.feature_id }}.error-context.json"
              echo "  error_context_resolved: âœ“" >> .ai/pipeline/${{ inputs.feature_id }}.state
            fi
          fi

      - name: Commit outputs
        if: steps.check_status.outputs.skip != 'true'
        run: |
          git config user.name "Pipeline Bot"
          git config user.email "pipeline@aid.local"
          git add .ai/pipeline/
          git commit -m "Dev: ${{ inputs.feature_id }} implementation complete" || echo "No changes"
          git push

  qa:
    needs: dev
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          ref: feature/${{ inputs.feature_id }}

      - name: Check if stage already complete
        id: check_status
        run: |
          if [ -f ".ai/pipeline/${{ inputs.feature_id }}.state" ]; then
            if grep -q "qa: âœ“" .ai/pipeline/${{ inputs.feature_id }}.state; then
              echo "Stage already complete, skipping"
              echo "skip=true" >> $GITHUB_OUTPUT
              exit 0
            fi
          fi
          echo "skip=false" >> $GITHUB_OUTPUT

      - name: Validate build results
        if: steps.check_status.outputs.skip != 'true'
        id: qa_check
        run: |
          echo "ðŸ§ª Running QA validation..."

          STATE_FILE=".ai/pipeline/${{ inputs.feature_id }}.state"

          # Check if build validation passed
          if grep -q "build_validation: âœ“" "$STATE_FILE"; then
            echo "âœ… Build validation passed"
            echo "qa_passed=true" >> $GITHUB_OUTPUT
          elif grep -q "build_validation: âœ—" "$STATE_FILE"; then
            echo "âŒ Build validation failed - blocking QA approval"
            echo "qa_passed=false" >> $GITHUB_OUTPUT
            exit 1
          elif grep -q "build_validation: - skipped" "$STATE_FILE"; then
            echo "âš ï¸  Build validation was skipped (no build commands)"
            echo "qa_passed=true" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸  No build validation results found, passing with warning"
            echo "qa_passed=true" >> $GITHUB_OUTPUT
          fi

          echo "âœ… QA checks complete"

      - name: Update pipeline state
        if: steps.check_status.outputs.skip != 'true'
        run: |
          sed -i 's/status:.*/status: qa_complete/' .ai/pipeline/${{ inputs.feature_id }}.state
          sed -i 's/qa: .*/qa: âœ“/' .ai/pipeline/${{ inputs.feature_id }}.state

      - name: Commit outputs
        run: |
          git config user.name "Pipeline Bot"
          git config user.email "pipeline@aid.local"
          git add design/validations/ .ai/pipeline/
          git commit -m "QA: ${{ inputs.feature_id }} validation complete" || echo "No changes"
          git push

  ops:
    needs: qa
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
        with:
          ref: feature/${{ inputs.feature_id }}

      - name: Check if stage already complete
        id: check_status
        run: |
          if [ -f ".ai/pipeline/${{ inputs.feature_id }}.state" ]; then
            if grep -q "ops: âœ“" .ai/pipeline/${{ inputs.feature_id }}.state; then
              echo "Stage already complete, skipping"
              echo "skip=true" >> $GITHUB_OUTPUT
              exit 0
            fi
          fi
          echo "skip=false" >> $GITHUB_OUTPUT

      - name: Set up Python
        if: steps.check_status.outputs.skip != 'true'
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        if: steps.check_status.outputs.skip != 'true'
        run: pip install openai google-genai python-dotenv

      - name: Run Ops Agent
        if: steps.check_status.outputs.skip != 'true'
        env:
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          AI_PROVIDER: ${{ vars.AI_PROVIDER }}
          MODEL: ${{ vars.MODEL }}
        run: |
          echo "ðŸš€ Running Ops Agent..."
          python scripts/invoke_ops_agent.py "${{ inputs.feature_id }}"

      - name: Update pipeline state
        if: steps.check_status.outputs.skip != 'true'
        run: |
          sed -i 's/status:.*/status: ops_complete/' .ai/pipeline/${{ inputs.feature_id }}.state
          sed -i 's/ops: .*/ops: âœ“/' .ai/pipeline/${{ inputs.feature_id }}.state

      - name: Commit outputs
        if: steps.check_status.outputs.skip != 'true'
        run: |
          git config user.name "Pipeline Bot"
          git config user.email "pipeline@aid.local"
          git add .ai/pipeline/
          git commit -m "Ops: ${{ inputs.feature_id }} deployment ready" || echo "No changes"
          git push

      - name: Create deployment PR to main
        if: steps.check_status.outputs.skip != 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh pr create \
            --base main \
            --head feature/${{ inputs.feature_id }} \
            --title "âœ… Deploy: ${{ inputs.feature_id }}" \
            --body "## Feature Ready for Deployment

          All pipeline stages completed for \`${{ inputs.feature_id }}\`.

          ### ðŸ” Pipeline Status
          - âœ“ Product Agent: Decision & experiment defined
          - âœ“ Design Agent: Specifications created
          - âœ“ Architect Agent: Technical review complete
          - âœ“ Dev Agent: Implementation complete
          - âœ“ QA Agent: Validation passed
          - âœ“ Ops Agent: Deployment ready

          ### ðŸš€ Deployment
          Merge this PR to deploy to main.

          _Ready for final review and deployment._" || true

          # Try to add labels if they exist (ignore if not)
          gh pr edit feature/${{ inputs.feature_id }} --add-label "deploy,awaiting-approval" 2>/dev/null || echo "Note: Labels not added (may not exist in repo)"

  handle-failure:
    needs: [product, design, architect, dev, qa, ops]
    if: failure()
    runs-on: ubuntu-latest
    permissions:
      actions: write
      contents: read
      issues: write
    steps:
      - uses: actions/checkout@v4

      - name: Create error issue and trigger fix
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          ERROR_ID="error-$(date -u +%Y%m%d-%H%M%S)"
          echo "ðŸ”´ Pipeline failed - creating issue and triggering auto-fix: $ERROR_ID"

          # Create issue
          ISSUE_URL=$(gh issue create \
            --title "ðŸ”´ Pipeline Failed: ${{ inputs.feature_id }} - $ERROR_ID" \
            --body "## Pipeline Failure

          **Feature ID:** \`${{ inputs.feature_id }}\`  
          **Error ID:** \`$ERROR_ID\`  
          **Workflow:** Pipeline  
          **Run:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

          ### Failed Stage
          One or more pipeline stages failed. Check the workflow run for details.

          ### Error Recovery Agent Task
          1. Download and analyze the failed workflow logs
          2. Identify the root cause of the failure
          3. Implement a minimal fix
          4. Create a PR with the fix
          5. Update this issue with findings

          ---
          _Auto-fix will be triggered automatically._")

          ISSUE_NUMBER=$(echo $ISSUE_URL | grep -oP '\d+$')
          echo "Created issue #$ISSUE_NUMBER"

          # Try to add labels (ignore if labels don't exist)
          gh issue edit "$ISSUE_NUMBER" --add-label "pipeline-error,auto-fix" 2>/dev/null || echo "Note: Labels not added (may not exist in repo)"

          # Trigger error-fix workflow
          gh workflow run error-fix.yml \
            -f error_id="$ERROR_ID" \
            -f issue_number="$ISSUE_NUMBER"
