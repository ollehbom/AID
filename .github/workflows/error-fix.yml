name: Error Fix Pipeline

on:
  workflow_dispatch:
    inputs:
      error_id:
        description: "Error ID to fix"
        required: true
      issue_number:
        description: "GitHub issue number"
        required: true

jobs:
  analyze-and-fix:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          pip install -r requirements.txt

      - name: Fetch issue details
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh issue view ${{ inputs.issue_number }} --json body -q .body > issue_body.txt

      - name: Run Error Recovery Agent
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
          AI_PROVIDER: ${{ vars.AI_PROVIDER || 'gemini' }}
          MODEL: ${{ vars.MODEL || 'gemini-2.5-flash' }}
          SAVE_JSON_ARTIFACTS: "true"
        run: |
          echo "üîç Analyzing error: ${{ inputs.error_id }}"
          python scripts/invoke_error_recovery_agent.py ${{ inputs.error_id }} issue_body.txt

      - name: Upload JSON artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: error-recovery-json-artifacts-${{ inputs.error_id }}
          path: json_artifacts/
          if-no-files-found: ignore

      - name: Create fix branch
        run: |
          git config user.name "Error Recovery Bot"
          git config user.email "error-recovery@aid.local"
          git checkout -b fix/${{ inputs.error_id }}

      - name: Commit fixes
        run: |
          git add -A
          git commit -m "üîß Auto-fix: ${{ inputs.error_id }}

          This commit was automatically generated by the Error Recovery Agent.

          Issue: #${{ inputs.issue_number }}
          Error ID: ${{ inputs.error_id }}

          Changes applied based on automated error analysis.
          See .ai/error-fixes/${{ inputs.error_id }}-analysis.json for details."

      - name: Push branch
        run: |
          git push origin fix/${{ inputs.error_id }}

      - name: Create Pull Request
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Read PR description from agent output
          if [ -f ".ai/error-fixes/${{ inputs.error_id }}-pr-description.md" ]; then
            PR_BODY=$(cat .ai/error-fixes/${{ inputs.error_id }}-pr-description.md)
          else
            PR_BODY="Automated fix for error ${{ inputs.error_id }}"
          fi

          gh pr create \
            --title "üîß Auto-fix: ${{ inputs.error_id }}" \
            --body "$PR_BODY" \
            --base main \
            --head fix/${{ inputs.error_id }}

          # Try to add labels (optional - don't fail if labels don't exist)
          gh pr edit fix/${{ inputs.error_id }} --add-label "auto-fix,pipeline-error" 2>/dev/null || true

      - name: Update Issue with Analysis
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Read issue update from agent output
          if [ -f ".ai/error-fixes/${{ inputs.error_id }}-issue-update.md" ]; then
            ISSUE_UPDATE=$(cat .ai/error-fixes/${{ inputs.error_id }}-issue-update.md)
            gh issue comment ${{ inputs.issue_number }} --body "$ISSUE_UPDATE"
          fi

      - name: Run validation tests
        id: validate
        continue-on-error: true
        run: |
          # Read validation commands from analysis
          if [ -f ".ai/error-fixes/${{ inputs.error_id }}-analysis.json" ]; then
            # Extract and run validation tests
            echo "Running validation tests..."
            
            # Try to run basic syntax checks
            if ls *.py 2>/dev/null; then
              python -m py_compile scripts/*.py || true
            fi
          fi

      - name: Report validation results
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          if [ "${{ steps.validate.outcome }}" == "success" ]; then
            gh issue comment ${{ inputs.issue_number }} --body "‚úÖ **Validation Passed**

            The automated fix has been validated and a PR has been created.
            The pipeline should now run successfully."
            
            # Add success label (optional - don't fail if label doesn't exist)
            gh issue edit ${{ inputs.issue_number }} --add-label "fix-validated" 2>/dev/null || true
          else
            gh issue comment ${{ inputs.issue_number }} --body "‚ö†Ô∏è **Validation Incomplete**

            A fix has been generated and a PR has been created, but validation could not be fully completed.
            Please review the PR before merging."
            
            # Add review label
            gh issue edit ${{ inputs.issue_number }} --add-label "needs-review"
          fi

  auto-merge:
    needs: analyze-and-fix
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
      actions: write
    outputs:
      merged: ${{ steps.merge.outputs.merged }}
      failed_workflow: ${{ steps.get-failed-workflow.outputs.workflow_name }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: main

      - name: Get failed workflow info
        id: get-failed-workflow
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Extract workflow name from issue body
          WORKFLOW_NAME=$(gh issue view ${{ inputs.issue_number }} --json body -q '.body' | grep -oP '(?<=\*\*Workflow\*\*: ).*' | head -1)
          echo "workflow_name=$WORKFLOW_NAME" >> $GITHUB_OUTPUT
          echo "Failed workflow: $WORKFLOW_NAME"

      - name: Wait for PR checks
        run: |
          echo "Waiting 60 seconds for PR checks to complete..."
          sleep 60

      - name: Auto-merge if tests pass
        id: merge
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Find the PR for this error_id
          PR_NUMBER=$(gh pr list --head fix/${{ inputs.error_id }} --json number -q '.[0].number')

          if [ -z "$PR_NUMBER" ]; then
            echo "No PR found for branch fix/${{ inputs.error_id }}"
            echo "merged=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "Found PR #$PR_NUMBER"

          # Wait for checks to complete (max 5 minutes)
          RETRY_COUNT=0
          MAX_RETRIES=30

          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            CHECKS_STATUS=$(gh pr view $PR_NUMBER --json statusCheckRollup -q '.statusCheckRollup[] | select(.status == "IN_PROGRESS" or .status == "QUEUED") | .status' | wc -l)
            
            if [ "$CHECKS_STATUS" == "0" ]; then
              echo "All checks completed"
              break
            fi
            
            echo "Waiting for checks to complete... ($RETRY_COUNT/$MAX_RETRIES)"
            sleep 10
            RETRY_COUNT=$((RETRY_COUNT + 1))
          done

          # Check if all checks passed
          FAILED_CHECKS=$(gh pr view $PR_NUMBER --json statusCheckRollup -q '.statusCheckRollup[] | select(.conclusion == "FAILURE") | .conclusion' | wc -l)

          if [ "$FAILED_CHECKS" == "0" ]; then
            echo "‚úÖ All checks passed, auto-merging to main..."
            gh pr merge $PR_NUMBER --merge --delete-branch
            
            echo "merged=true" >> $GITHUB_OUTPUT
            
            gh issue comment ${{ inputs.issue_number }} --body "‚úÖ **Auto-Fix Merged Successfully**

            The automated fix has been merged to main.
            The pipeline will now be re-triggered to verify the fix."
            
            gh issue edit ${{ inputs.issue_number }} --add-label "fix-merged"
          else
            echo "‚ùå Some checks failed, skipping auto-merge"
            echo "merged=false" >> $GITHUB_OUTPUT
            
            gh issue comment ${{ inputs.issue_number }} --body "‚ö†Ô∏è **Auto-Merge Blocked**

            PR #$PR_NUMBER created but some checks failed.
            Please review the PR and fix any issues before merging manually."
            
            gh issue edit ${{ inputs.issue_number }} --add-label "needs-review"
          fi

  trigger-workflow:
    needs: auto-merge
    if: needs.auto-merge.outputs.merged == 'true'
    runs-on: ubuntu-latest
    permissions:
      actions: write
      issues: write
    steps:
      - uses: actions/checkout@v4

      - name: Determine workflow to trigger
        id: determine-workflow
        run: |
          WORKFLOW_NAME="${{ needs.auto-merge.outputs.failed_workflow }}"

          # Map workflow names to their file names
          case "$WORKFLOW_NAME" in
            "Product Agent")
              WORKFLOW_FILE="product-agent.yml"
              ;;
            "Design Agent")
              WORKFLOW_FILE="design-agent.yml"
              ;;
            "Architect Agent")
              WORKFLOW_FILE="architect-agent.yml"
              ;;
            "Dev Agent")
              WORKFLOW_FILE="dev-agent.yml"
              ;;
            "QA Agent")
              WORKFLOW_FILE="qa-agent.yml"
              ;;
            "Ops Agent")
              WORKFLOW_FILE="ops-agent.yml"
              ;;
            "Stage Router")
              WORKFLOW_FILE="stage-router.yml"
              ;;
            "Pipeline Orchestrator")
              WORKFLOW_FILE="pipeline-orchestrator.yml"
              ;;
            *)
              # Default to full pipeline
              WORKFLOW_FILE="pipeline-orchestrator.yml"
              ;;
          esac

          echo "workflow_file=$WORKFLOW_FILE" >> $GITHUB_OUTPUT
          echo "Will trigger: $WORKFLOW_FILE"

      - name: Re-trigger workflow
        uses: actions/github-script@v7
        with:
          script: |
            const workflowFile = '${{ steps.determine-workflow.outputs.workflow_file }}';

            console.log(`Re-triggering workflow: ${workflowFile}`);

            try {
              await github.rest.actions.createWorkflowDispatch({
                owner: context.repo.owner,
                repo: context.repo.repo,
                workflow_id: workflowFile,
                ref: 'main'
              });
              
              console.log('‚úÖ Workflow triggered successfully');
            } catch (error) {
              console.error('‚ùå Failed to trigger workflow:', error);
              
              // Comment on issue
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: ${{ inputs.issue_number }},
                body: `‚ö†Ô∏è **Workflow Re-trigger Failed**\n\nCould not automatically re-trigger ${workflowFile}.\nPlease trigger it manually.\n\nError: ${error.message}`
              });
            }

      - name: Update issue with re-trigger status
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh issue comment ${{ inputs.issue_number }} --body "üîÑ **Pipeline Re-triggered**

          The workflow has been automatically re-triggered to verify the fix.
          Workflow: ${{ steps.determine-workflow.outputs.workflow_file }}

          If the pipeline succeeds, this issue can be closed."
