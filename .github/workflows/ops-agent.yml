name: Ops Agent

on:
  workflow_dispatch:
    inputs:
      feature_id:
        description: "Feature ID to process"
        required: true

jobs:
  run-agent:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      actions: write
    steps:
      - uses: actions/checkout@v4
        with:
          ref: feature/${{ inputs.feature_id }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          pip install openai google-genai python-dotenv

      - name: Run Ops Agent
        env:
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          AI_PROVIDER: ${{ vars.AI_PROVIDER }}
          MODEL: ${{ vars.MODEL }}
        run: |
          python scripts/invoke_ops_agent.py "${{ inputs.feature_id }}"

      - name: Update pipeline state
        run: |
          sed -i 's/status:.*/status: ops_complete/' .ai/pipeline/${{ inputs.feature_id }}.state
          sed -i 's/ops: .*/ops: âœ“/' .ai/pipeline/${{ inputs.feature_id }}.state

      - name: Commit outputs
        run: |
          git config user.name "Pipeline Bot"
          git config user.email "pipeline@aid.local"
          git add .ai/pipeline/
          git commit -m "Ops: ${{ inputs.feature_id }} deployment ready" || echo "No changes to commit"
          git push

      - name: Create final PR to main
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh pr create \
            --base main \
            --head feature/${{ inputs.feature_id }} \
            --title "âœ… Deploy: ${{ inputs.feature_id }}" \
            --body "## Feature Ready for Deployment

          All pipeline stages completed for \`${{ inputs.feature_id }}\`.

          ### ğŸ” Pipeline Status
          - âœ“ Product Agent: Decision & experiment defined
          - âœ“ Design Agent: Specifications created
          - âœ“ Architect Agent: Technical review complete
          - âœ“ Dev Agent: Implementation complete
          - âœ“ QA Agent: Validation passed
          - âœ“ Ops Agent: Deployment ready

          ### ğŸš€ Deployment
          Merge this PR to deploy to main.

          _Ready for final review and deployment._" \
            --label "deploy,awaiting-approval"

      - name: Handle failure
        if: failure()
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          ERROR_ID="error-$(date +%Y%m%d-%H%M%S)"
          echo "ğŸ”´ Workflow failed - triggering auto-fix: $ERROR_ID"
          gh workflow run error-fix.yml -f error_id="$ERROR_ID" -f workflow_name="Ops Agent"
